<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y7PF0CH00W"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-Y7PF0CH00W');
    </script>
    <title>Track Your Order - RideWatch</title>
    <meta name="description"
        content="Track your RideWatch delivery in real-time. View rider location and ETA without downloading any apps.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Track Your Delivery - RideWatch">
    <meta property="og:description" content="View real-time location and ETA. No app download required.">
    <meta property="og:image" content="https://ridewatchapp.com/assets/og-track.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Track Your Delivery - RideWatch">
    <meta property="twitter:description" content="View real-time location and ETA. No app download required.">
    <meta property="twitter:image" content="https://ridewatchapp.com/assets/og-track.png">
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        #map {
            position: fixed;
            inset: 0;
            z-index: 0;
        }

        .overlay {
            position: relative;
            z-index: 10;
            pointer-events: none;
        }

        .overlay>* {
            pointer-events: auto;
        }

        .leaflet-control-attribution {
            display: none;
        }

        /* Rider marker pulse */
        @keyframes rider-pulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
            }

            50% {
                transform: scale(1.08);
                box-shadow: 0 0 0 12px rgba(34, 197, 94, 0);
            }
        }

        .rider-marker-inner {
            animation: rider-pulse 2s ease-in-out infinite;
        }

        /* Bottom sheet */
        .bottom-sheet {
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -8px 40px rgba(0, 0, 0, 0.15);
            transition: max-height 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            overflow: hidden;
        }

        .bottom-sheet.collapsed {
            max-height: 140px;
        }

        .bottom-sheet.expanded {
            max-height: 75vh;
            overflow-y: auto;
        }

        .bottom-sheet::-webkit-scrollbar {
            display: none;
        }

        .expand-toggle {
            transition: transform 0.3s ease;
        }

        .expand-toggle.rotated {
            transform: rotate(180deg);
        }

        /* Step indicator */
        .step-line {
            width: 2px;
            background: #e2e8f0;
            transition: background 0.5s ease;
        }

        .step-line.completed {
            background: #22c55e;
        }

        .step-line.active {
            background: linear-gradient(to bottom, #22c55e, #e2e8f0);
        }

        .step-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .step-dot.completed {
            background: #22c55e;
            color: white;
        }

        .step-dot.active {
            background: #22c55e;
            color: white;
            animation: rider-pulse 2s ease-in-out infinite;
        }

        .step-dot.pending {
            background: #f1f5f9;
            color: #94a3b8;
            border: 2px solid #e2e8f0;
        }

        /* Arrival celebration */
        @keyframes celebrate {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .celebrate {
            animation: celebrate 0.5s ease-out;
        }

        /* Slide up animation */
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .slide-up {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Proximity banner */
        @keyframes glow {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
            }

            50% {
                box-shadow: 0 0 40px rgba(34, 197, 94, 0.6);
            }
        }

        .glow {
            animation: glow 1.5s ease-in-out infinite;
        }

        /* Stop code shimmer */
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .shimmer-bg {
            background: linear-gradient(90deg, #22c55e 0%, #34d399 25%, #6ee7b7 50%, #34d399 75%, #22c55e 100%);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }

        /* Smooth Marker Animation */
        .smooth-marker {
            transition: transform 1s linear;
        }
    </style>
    <style>
        .bg-oled {
            background-color: #000000;
        }

        .text-terminal {
            color: #4ade80;
        }

        /* Viral Footer */
        .viral-footer {
            background: linear-gradient(to right, #0f172a, #1e293b);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px;
            text-align: center;
            font-size: 12px;
            color: #94a3b8;
        }

        .viral-link {
            color: #34d399;
            font-weight: 600;
            text-decoration: none;
        }

        /* Rating Stars */
        .rating-star {
            font-size: 32px;
            color: #ccc;
            cursor: pointer;
            transition: color 0.2s;
        }

        .rating-star.active {
            color: #fbbf24;
        }
    </style>
</head>

<body class="bg-slate-50 font-sans" x-data="customerTracker()" x-init="init()">
    <!-- Rating Modal -->
    <div x-show="showRatingModal" x-cloak
        class="fixed inset-0 z-[70] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center space-y-4 slide-up">
            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center text-3xl mx-auto">
                ‚≠ê
            </div>
            <h2 class="text-xl font-bold text-slate-900">Rate your experience</h2>
            <p class="text-slate-500 text-sm">How was your delivery with <span x-text="riderName"></span>?</p>

            <div class="flex justify-center gap-2 py-2">
                <template x-for="star in 5">
                    <span class="rating-star" :class="{'active': currentRating >= star}"
                        @click="currentRating = star">‚òÖ</span>
                </template>
            </div>

            <textarea x-model="ratingComment"
                class="w-full p-3 border border-slate-200 rounded-xl text-sm focus:border-green-500 outline-none"
                placeholder="Any comments? (Optional)"></textarea>

            <button @click="submitRating"
                class="w-full py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition">
                Submit Feedback
            </button>
            <button @click="showRatingModal = false" class="text-slate-400 text-xs">Skip</button>
        </div>
    </div>
    <!-- Toast Notification -->
    <div x-data="{ show: false, message: '' }"
        @show-toast.window="show = true; message = $event.detail; setTimeout(() => show = false, 3000)" x-show="show"
        x-transition.opacity.duration.300ms
        class="fixed top-6 left-1/2 transform -translate-x-1/2 z-[9999] bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl border border-slate-600 flex items-center gap-3">
        <span>üîî</span>
        <span x-text="message" class="font-medium text-sm"></span>
    </div>

    <!-- Phone Registration Modal -->
    <div x-show="showPhoneModal" x-cloak
        class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm p-0 sm:p-4">
        <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl max-w-sm w-full p-8 space-y-6 slide-up">
            <div class="text-center">
                <div class="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center text-3xl mx-auto mb-3">
                    üì¶</div>
                <h2 class="text-2xl font-extrabold text-slate-900">Track Your Delivery</h2>
                <p class="text-sm text-slate-500 mt-2">Enter your phone number to start tracking</p>
            </div>
            <form @submit.prevent="registerPhone">
                <div class="space-y-4">
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-lg">üì±</span>
                        <input type="tel" x-model="customerPhone" required
                            class="w-full pl-12 pr-4 py-4 text-lg border-2 border-slate-200 rounded-2xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition font-medium"
                            placeholder="08012345678" pattern="[0-9]{10,11}">
                    </div>
                    <button type="submit"
                        class="w-full py-4 bg-green-600 text-white font-bold text-lg rounded-2xl hover:bg-green-700 active:scale-[0.98] transition-all shadow-lg shadow-green-600/25">
                        Start Tracking ‚Üí
                    </button>
                </div>
            </form>
            <p class="text-xs text-center text-slate-400">üîí Your number is only used for this delivery</p>
        </div>
    </div>

    <!-- Cancellation Overlay -->
    <div x-show="isCancelled" x-cloak
        class="fixed inset-0 z-[60] bg-slate-900/95 backdrop-blur-sm flex flex-col items-center justify-center p-8 text-center animate-fade-in text-white">
        <div class="text-8xl mb-6">üö´</div>
        <h2 class="text-3xl font-bold mb-2">Order Cancelled</h2>
        <p class="text-lg text-slate-300">This delivery has been cancelled by the vendor.</p>
        <button @click="window.location.reload()"
            class="mt-8 px-8 py-3 bg-white text-slate-900 font-bold rounded-xl active:scale-95 transition">
            Refresh Status
        </button>
    </div>

    <!-- Full-screen Map -->
    <div id="map" x-show="!showPhoneModal"></div>

    <!-- Overlay UI -->
    <div x-show="!showPhoneModal" class="overlay min-h-screen flex flex-col">

        <!-- Top Bar -->
        <header class="bg-white/90 backdrop-blur-xl shadow-sm py-3 px-4">
            <div class="flex items-center justify-between max-w-lg mx-auto">
                <div class="flex items-center space-x-3">
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center text-white text-lg shadow-md shadow-green-500/20">
                        üì¶
                    </div>
                    <div>
                        <div class="font-bold text-slate-900 text-sm" x-text="headerTitle">Loading...</div>
                        <div class="text-xs text-slate-500" x-text="`Order: ${orderRef}`"></div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-xl font-extrabold" :class="etaColor" x-text="eta || '--'"></div>
                    <div class="text-[10px] uppercase tracking-wider text-slate-400 font-semibold">ETA</div>
                </div>
            </div>
        </header>

        <!-- Proximity Alert Banner -->
        <div x-show="proximityAlertShown" x-cloak x-transition
            class="mx-4 mt-2 bg-green-600 text-white px-4 py-3 rounded-2xl flex items-center justify-between glow"
            @click="proximityAlertShown = false">
            <div class="flex items-center space-x-2">
                <span class="text-xl">üîî</span>
                <span class="font-semibold text-sm">Your rider is almost here!</span>
            </div>
            <span class="text-xs opacity-75">dismiss</span>
        </div>

        <!-- Map Actions -->
        <div class="flex justify-end px-4 mt-3 space-x-2">
            <button @click="fitMapBounds()"
                class="bg-white/90 backdrop-blur shadow-md rounded-xl px-3 py-2 text-xs font-semibold text-slate-600 hover:bg-white transition">
                üó∫ Fit All
            </button>
            <button @click="useMyLocation()"
                class="bg-white/90 backdrop-blur shadow-md rounded-xl px-3 py-2 text-xs font-semibold text-green-600 hover:bg-white transition">
                üìç My Location
            </button>
        </div>

        <!-- Spacer -->
        <div class="flex-1"></div>

        <!-- Bottom Sheet -->
        <div class="bottom-sheet bg-white/95 backdrop-blur-xl slide-up"
            :class="sheetExpanded ? 'expanded' : 'collapsed'">
            <div class="max-w-lg mx-auto">

                <!-- Compact View (always visible) -->
                <div class="p-4 cursor-pointer" @click="toggleSheet()">
                    <!-- Drag Handle -->
                    <div class="flex justify-center mb-3">
                        <div class="w-10 h-1 bg-slate-300 rounded-full"></div>
                    </div>

                    <!-- Compact Status Row -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3 min-w-0 flex-1">
                            <div class="w-11 h-11 rounded-full flex items-center justify-center text-xl flex-shrink-0"
                                :class="statusIconBg">
                                <span x-text="statusIcon"></span>
                            </div>
                            <div class="min-w-0">
                                <div class="font-semibold text-slate-800 text-sm truncate" x-text="statusLabel"></div>
                                <div class="text-xs text-slate-400" x-text="lastUpdate || `${distanceKm} km away`">
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3 flex-shrink-0">
                            <div class="text-right">
                                <div class="text-lg font-bold" :class="etaColor" x-text="eta || '--'"></div>
                                <div class="text-[10px] text-slate-400 uppercase tracking-wider">ETA</div>
                            </div>
                            <div class="expand-toggle text-slate-400 text-lg" :class="sheetExpanded ? 'rotated' : ''">
                                ‚ñ≤
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Expanded Details -->
                <div x-show="sheetExpanded" x-transition class="px-4 pb-5 space-y-4">

                    <!-- Stop Code -->
                    <!-- Stop Code -->
                    <div x-show="showStopCode" x-transition
                        class="shimmer-bg text-white rounded-2xl p-4 text-center shadow-lg">
                        <div class="text-xs font-semibold opacity-90 mb-1 uppercase tracking-wider">üîê Stop Code
                        </div>
                        <div class="text-4xl font-black tracking-[0.4em] font-mono" x-text="stopCode">----</div>
                        <div class="text-xs opacity-75 mt-1">Share this code when rider arrives</div>
                    </div>

                    <!-- Driver Profile -->
                    <div x-show="status !== 'pending'"
                        class="bg-white border border-slate-100 rounded-2xl p-4 shadow-sm flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div
                                class="w-12 h-12 rounded-full bg-slate-200 overflow-hidden relative border-2 border-white shadow-sm">
                                <template x-if="riderPhoto">
                                    <img :src="riderPhoto" class="w-full h-full object-cover">
                                </template>
                                <template x-if="!riderPhoto">
                                    <div class="w-full h-full flex items-center justify-center text-xl">üë§</div>
                                </template>
                            </div>
                            <div>
                                <div class="font-bold text-slate-800" x-text="riderName || 'Your Rider'"></div>
                                <div class="flex items-center text-xs text-slate-500">
                                    <span class="text-yellow-500 mr-1">‚òÖ</span> 4.9
                                </div>
                            </div>
                        </div>
                        <a :href="`tel:${riderPhone}`" x-show="riderPhone"
                            class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600 hover:bg-green-200 transition">
                            üìû
                        </a>
                    </div>

                    <!-- Delivery Stage Tracker -->
                    <div class="space-y-0">
                        <template x-for="(step, index) in deliverySteps" :key="index">
                            <div class="flex items-start">
                                <div class="flex flex-col items-center mr-3">
                                    <div class="step-dot" :class="step.state"
                                        style="width:28px;height:28px;font-size:12px;">
                                        <span x-text="step.icon"></span>
                                    </div>
                                    <div x-show="index < deliverySteps.length - 1" class="step-line h-6"
                                        :class="step.lineState"></div>
                                </div>
                                <div class="pt-0.5 pb-1 min-w-0">
                                    <div class="font-semibold text-sm"
                                        :class="step.state === 'pending' ? 'text-slate-400' : 'text-slate-900'"
                                        x-text="step.label"></div>
                                    <div class="text-xs"
                                        :class="step.state === 'active' ? 'text-green-600 font-medium' : 'text-slate-400'"
                                        x-text="step.subtitle"></div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Distance Info -->
                    <div class="flex items-center justify-between bg-slate-50 rounded-xl p-3">
                        <div class="text-sm text-slate-600">Distance remaining</div>
                        <div class="font-bold text-slate-800" x-text="`${distanceKm} km`"></div>
                    </div>

                    <!-- Addresses -->
                    <div x-show="pickupAddress || destAddress" class="space-y-2">
                        <div x-show="pickupAddress" class="flex items-center space-x-3 text-sm">
                            <div
                                class="w-7 h-7 rounded-lg bg-amber-100 flex items-center justify-center text-xs flex-shrink-0">
                                üì¶</div>
                            <div class="min-w-0">
                                <div class="text-[10px] uppercase tracking-wider text-slate-400 font-semibold">Pickup
                                </div>
                                <div class="text-slate-700 font-medium text-xs truncate" x-text="pickupAddress"></div>
                            </div>
                        </div>
                        <div x-show="destAddress" class="flex items-center space-x-3 text-sm">
                            <div
                                class="w-7 h-7 rounded-lg bg-green-100 flex items-center justify-center text-xs flex-shrink-0">
                                üè†</div>
                            <div class="min-w-0">
                                <div class="text-[10px] uppercase tracking-wider text-slate-400 font-semibold">Dropoff
                                </div>
                                <div class="text-slate-700 font-medium text-xs truncate" x-text="destAddress"></div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center text-[11px] text-slate-400 pb-1">
                        üîí Your rider's identity is protected for safety
                    </div>
                </div>

                <!-- Viral Footer -->
                <div class="viral-footer">
                    Powered by <a href="/" class="viral-link" target="_blank">RideWatch</a>.
                    <a href="/vendor" class="text-slate-400 hover:text-white ml-1" target="_blank">Run your own
                        fleet?</a>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('customerTracker', () => ({
                map: null,
                riderMarker: null,
                destinationMarker: null,
                pickupMarker: null,
                routePolyline: null,
                userLocationMarker: null,
                userLocationPulse: null,

                // Phone registration
                showPhoneModal: true,
                customerPhone: '',
                isCancelled: false,

                // Session info
                sessionId: null,
                orderRef: 'Loading...',
                stopCode: '----',

                // Status
                status: 'pending',
                confettiShown: false,
                statusLabel: 'Waiting for rider...',
                lastUpdate: '',

                // Locations from vendor
                pickupLat: null,
                pickupLng: null,
                pickupAddress: '',

                // Rider current location
                riderLat: null,
                riderLng: null,
                riderName: '',
                riderPhone: '',
                riderPhoto: '',
                vehicleType: '',

                // Dropoff/customer location
                destLat: null,
                destLng: null,
                destAddress: '',

                // Calculated
                distanceKm: '0.0',
                eta: '-- min',
                progress: 0,

                // Proximity alerts
                hasPlayedAlert: false,
                proximityAlertShown: false,
                sheetExpanded: false,

                // Ratings
                showRatingModal: false,
                currentRating: 0,
                ratingComment: '',

                // Timestamps
                pickedUpAt: null,
                startedAt: null,

                firebaseEnabled: false,

                // Computed properties
                get headerTitle() {
                    const titles = {
                        'pending': 'Preparing Your Order',
                        'en_route_to_pickup': 'Rider Heading to Pickup',
                        'picked_up': 'Package Collected!',
                        'active': 'On The Way To You!',
                        'completed': 'Delivered! üéâ'
                    };
                    return titles[this.status] || 'Your Order is On The Way!';
                },

                get etaColor() {
                    if (this.status === 'completed') return 'text-green-600';
                    if (this.eta === 'Arriving!') return 'text-green-600';
                    return 'text-slate-800';
                },

                get showStopCode() {
                    return this.status === 'picked_up' || this.status === 'active' ||
                        (this.status === 'en_route_to_pickup' && parseFloat(this.distanceKm) < 2);
                },

                get statusIcon() {
                    const icons = {
                        'pending': '‚è≥',
                        'en_route_to_pickup': 'üèÉ',
                        'picked_up': 'üì¶',
                        'active': 'üõµ',
                        'completed': '‚úÖ'
                    };
                    return icons[this.status] || '‚è≥';
                },

                get statusIconBg() {
                    const bgs = {
                        'pending': 'bg-yellow-100',
                        'en_route_to_pickup': 'bg-blue-100',
                        'picked_up': 'bg-purple-100',
                        'active': 'bg-green-100',
                        'completed': 'bg-green-100'
                    };
                    return bgs[this.status] || 'bg-yellow-100';
                },

                get deliverySteps() {
                    const stageIndex = {
                        'pending': 0,
                        'en_route_to_pickup': 1,
                        'picked_up': 2,
                        'active': 2,
                        'completed': 4
                    };
                    const currentIndex = stageIndex[this.status] ?? 0;

                    const steps = [
                        { icon: '‚úì', label: 'Order Confirmed', subtitle: this.orderRef },
                        { icon: 'üèÉ', label: 'Rider En Route to Pickup', subtitle: this.status === 'en_route_to_pickup' ? 'Heading there now...' : '' },
                        { icon: 'üì¶', label: 'Package Picked Up', subtitle: this.pickedUpAt ? this.formatTime(this.pickedUpAt) : '' },
                        { icon: 'üõµ', label: 'On the Way to You', subtitle: this.status === 'active' || this.status === 'picked_up' ? `${this.distanceKm} km away` : '' },
                        { icon: 'üè†', label: 'Delivered', subtitle: this.status === 'completed' ? 'Package delivered!' : '' }
                    ];

                    return steps.map((step, i) => {
                        let state = 'pending';
                        if (i < currentIndex) state = 'completed';
                        else if (i === currentIndex) state = 'active';

                        // Special: picked_up means step 2 is completed and step 3 is active
                        if (this.status === 'picked_up' && i === 2) state = 'completed';
                        if (this.status === 'picked_up' && i === 3) state = 'active';
                        if (this.status === 'active' && i === 2) state = 'completed';
                        if (this.status === 'active' && i === 3) state = 'active';

                        let lineState = 'pending';
                        if (state === 'completed') lineState = 'completed';
                        else if (state === 'active') lineState = 'active';

                        return { ...step, state, lineState };
                    });
                },

                formatTime(timestamp) {
                    if (!timestamp) return '';
                    const d = new Date(timestamp);
                    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                },

                async init() {
                    const params = new URLSearchParams(window.location.search);
                    this.sessionId = params.get('session') || 'demo';

                    try {
                        if (typeof firebase !== 'undefined' && typeof firebaseConfig !== 'undefined' &&
                            firebaseConfig.apiKey && firebaseConfig.apiKey !== 'YOUR_API_KEY') {
                            if (!firebase.apps.length) {
                                firebase.initializeApp(firebaseConfig);
                            }
                            this.firebaseEnabled = true;
                        }
                    } catch (e) {
                        console.log('Firebase not available, using demo mode');
                        this.firebaseEnabled = false;
                    }

                    const savedPhone = localStorage.getItem(`customer_${this.sessionId}`);
                    if (savedPhone) {
                        this.customerPhone = savedPhone;
                        this.showPhoneModal = false;
                        await this.loadSession();
                        this.$nextTick(() => { this.initMap(); });
                    }
                },

                async registerPhone() {
                    if (!this.customerPhone || this.customerPhone.length < 10) {
                        window.dispatchEvent(new CustomEvent('show-toast', { detail: 'Please enter a valid phone number' }));
                        return;
                    }

                    localStorage.setItem(`customer_${this.sessionId}`, this.customerPhone);

                    if (this.firebaseEnabled) {
                        try {
                            await firebase.database().ref(`sessions/${this.sessionId}`).update({
                                customerPhone: this.customerPhone,
                                customerRegisteredAt: Date.now()
                            });
                        } catch (e) {
                            console.log('Firebase update failed:', e);
                        }
                    }

                    this.showPhoneModal = false;
                    await this.loadSession();
                    this.$nextTick(() => { this.initMap(); });
                },

                async loadSession() {
                    if (!this.firebaseEnabled) {
                        this.orderRef = 'ORD-DEMO';
                        this.stopCode = '4829';
                        this.pickupLat = 6.5244;
                        this.pickupLng = 3.3792;
                        this.pickupAddress = 'Lekki Phase 1, Lagos';
                        this.destLat = 6.4541;
                        this.destLng = 3.3947;
                        this.destAddress = 'Victoria Island, Lagos';
                        this.riderLat = 6.5244;
                        this.riderLng = 3.3792;
                        this.status = 'en_route_to_pickup';
                        this.updateStatusLabel();
                        // Markers will be placed by initMap() which runs after loadSession completes
                        this.startMockUpdates();
                        return;
                    }

                    try {
                        const snapshot = await firebase.database().ref(`sessions/${this.sessionId}`).once('value');
                        const session = snapshot.val();
                        if (session) {
                            this.orderRef = session.refId || this.sessionId;
                            this.stopCode = session.stopCode || '----';
                            this.status = session.status || 'pending';
                            this.pickedUpAt = session.pickedUpAt || null;
                            this.startedAt = session.startedAt || null;

                            if (session.pickup && session.pickup.lat && session.pickup.lng) {
                                this.pickupLat = session.pickup.lat;
                                this.pickupLng = session.pickup.lng;
                                this.pickupAddress = session.pickup.address || '';
                            }

                            if (session.dropoff && session.dropoff.lat && session.dropoff.lng) {
                                this.destLat = session.dropoff.lat;
                                this.destLng = session.dropoff.lng;
                                this.destAddress = session.dropoff.address || '';
                            }

                            if (session.lat && session.lng) {
                                this.riderLat = session.lat;
                                this.riderLng = session.lng;
                            }

                            this.updateStatusLabel();
                            // Markers will be placed after initMap runs
                            this.$nextTick(() => {
                                this.updatePickupMarker();
                                this.updateDestMarker();
                                this.updateRiderMarker();
                                this.updateCalculations();
                                this.fitMapBounds();
                            });
                            this.subscribeToUpdates();
                        } else {
                            this.orderRef = 'ORD-DEMO';
                            this.stopCode = '4829';
                            this.startMockUpdates();
                        }
                    } catch (e) {
                        console.log('Firebase error:', e);
                        this.orderRef = 'ORD-DEMO';
                        this.stopCode = '4829';
                        this.startMockUpdates();
                    }
                },

                updateStatusLabel() {
                    const labels = {
                        'pending': 'Waiting for rider...',
                        'en_route_to_pickup': 'Rider heading to pick up your package',
                        'picked_up': 'Package collected! On the way to you',
                        'active': 'Your rider is heading your way',
                        'completed': 'Delivery Complete! üéâ'
                    };
                    this.statusLabel = labels[this.status] || 'Tracking your delivery...';
                },

                subscribeToUpdates() {
                    // Listen for session status changes
                    firebase.database().ref(`sessions/${this.sessionId}`).on('value', (snapshot) => {
                        const session = snapshot.val();
                        if (session) {
                            this.status = session.status;
                            this.pickedUpAt = session.pickedUpAt || this.pickedUpAt;
                            this.startedAt = session.startedAt || this.startedAt;
                            this.updateStatusLabel();

                            // Vibrate on pickup
                            if (session.status === 'picked_up' && 'vibrate' in navigator) {
                                navigator.vibrate([100, 50, 100]);
                            }

                            if (session.status === 'cancelled') {
                                this.isCancelled = true;
                                this.statusLabel = 'Order Cancelled';
                            }

                            if (session.status === 'completed') {
                                this.eta = 'Done!';
                                this.progress = 100;
                                if (window.confetti && !this.confettiShown) {
                                    confetti({
                                        particleCount: 150,
                                        spread: 70,
                                        origin: { y: 0.6 },
                                        colors: ['#22c55e', '#3b82f6', '#f59e0b']
                                    });
                                    this.confettiShown = true;

                                    // Show rating modal after delay
                                    setTimeout(() => {
                                        if (!localStorage.getItem(`rated_${this.sessionId}`)) {
                                            this.showRatingModal = true;
                                        }
                                    }, 2000);
                                }
                            }
                        }
                    });

                    // Listen for rider location updates
                    firebase.database().ref(`locations/${this.sessionId}`).orderByKey().limitToLast(1)
                        .on('child_added', (snapshot) => {
                            const location = snapshot.val();
                            if (location) {
                                this.riderLat = location.lat;
                                this.riderLng = location.lng;
                                this.lastUpdate = 'Just now';
                                this.updateRiderMarker();
                                this.updateCalculations();
                            }
                        });
                },

                async submitRating() {
                    if (this.currentRating === 0) return;

                    try {
                        if (this.firebaseEnabled) {
                            await firebase.database().ref(`ratings/${this.sessionId}`).set({
                                rating: this.currentRating,
                                comment: this.ratingComment,
                                timestamp: Date.now(),
                                riderName: this.riderName
                            });

                            // Also update session
                            await firebase.database().ref(`sessions/${this.sessionId}/rating`).set(this.currentRating);
                        }

                        localStorage.setItem(`rated_${this.sessionId}`, 'true');
                        this.showRatingModal = false;
                        window.dispatchEvent(new CustomEvent('show-toast', { detail: 'Thanks for your feedback! ‚≠ê' }));
                    } catch (e) {
                        console.error('Rating failed', e);
                    }
                },

                initMap() {
                    if (this.map) return;

                    const points = [];
                    if (this.pickupLat && this.pickupLng) points.push([this.pickupLat, this.pickupLng]);
                    if (this.riderLat && this.riderLng) points.push([this.riderLat, this.riderLng]);
                    if (this.destLat && this.destLng) points.push([this.destLat, this.destLng]);

                    let centerLat = 6.5244, centerLng = 3.3792;
                    if (points.length > 0) {
                        centerLat = points.reduce((sum, p) => sum + p[0], 0) / points.length;
                        centerLng = points.reduce((sum, p) => sum + p[1], 0) / points.length;
                    }

                    this.map = L.map('map', {
                        zoomControl: false,
                        attributionControl: false
                    }).setView([centerLat, centerLng], 13);

                    // Use a cleaner tile style
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19
                    }).addTo(this.map);

                    this.updatePickupMarker();
                    this.updateDestMarker();
                    this.updateRiderMarker();
                    if (this.riderMarker) this.riderMarker.setZIndexOffset(1000);
                    this.updateRoute();
                    this.fitMapBounds();
                    this.updateCalculations();
                },

                useMyLocation() {
                    if ('geolocation' in navigator) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const lat = position.coords.latitude;
                                const lng = position.coords.longitude;

                                // Show blue dot
                                if (this.userLocationMarker) {
                                    this.userLocationMarker.setLatLng([lat, lng]);
                                    if (this.userLocationPulse) this.userLocationPulse.setLatLng([lat, lng]);
                                } else {
                                    this.userLocationMarker = L.circleMarker([lat, lng], {
                                        radius: 8,
                                        fillColor: '#3b82f6',
                                        color: '#ffffff',
                                        weight: 2,
                                        opacity: 1,
                                        fillOpacity: 1
                                    }).addTo(this.map);

                                    this.userLocationPulse = L.circle([lat, lng], {
                                        radius: 200, // Meters? No, L.circle uses meters. L.circleMarker uses pixels.
                                        color: '#3b82f6',
                                        weight: 1,
                                        opacity: 0.5,
                                        fillOpacity: 0.2
                                    }).addTo(this.map);
                                }

                                // Center map
                                this.map.setView([lat, lng], 15);
                                window.dispatchEvent(new CustomEvent('show-toast', { detail: 'Showing your current location' }));
                            },
                            (error) => {
                                window.dispatchEvent(new CustomEvent('show-toast', { detail: 'Could not get location. Check permissions.' }));
                            }
                        );
                    }
                },

                updatePickupMarker() {
                    if (!this.map || !this.pickupLat || !this.pickupLng) return;

                    const pickupIcon = L.divIcon({
                        className: 'pickup-marker',
                        html: `<div style="background: linear-gradient(135deg, #f59e0b, #d97706); width: 38px; height: 38px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 12px rgba(245,158,11,0.4); display: flex; align-items: center; justify-content: center; font-size: 18px;">üì¶</div>`,
                        iconSize: [38, 38],
                        iconAnchor: [19, 19]
                    });

                    if (this.pickupMarker) {
                        this.pickupMarker.setLatLng([this.pickupLat, this.pickupLng]);
                    } else {
                        this.pickupMarker = L.marker([this.pickupLat, this.pickupLng], { icon: pickupIcon })
                            .bindPopup(`<b>üì¶ Pickup</b><br>${this.pickupAddress || 'Pickup location'}`)
                            .addTo(this.map);
                    }
                },

                updateDestMarker() {
                    if (!this.map || !this.destLat || !this.destLng) return;

                    const destIcon = L.divIcon({
                        className: 'dest-marker',
                        html: `<div style="background: white; width: 38px; height: 38px; border-radius: 50%; border: 3px solid #22c55e; box-shadow: 0 4px 12px rgba(34,197,94,0.3); display: flex; align-items: center; justify-content: center; font-size: 18px;">üè†</div>`,
                        iconSize: [38, 38],
                        iconAnchor: [19, 19]
                    });

                    if (this.destinationMarker) {
                        this.destinationMarker.setLatLng([this.destLat, this.destLng]);
                    } else {
                        this.destinationMarker = L.marker([this.destLat, this.destLng], { icon: destIcon })
                            .bindPopup(`<b>üè† Dropoff</b><br>${this.destAddress || 'Delivery destination'}`)
                            .addTo(this.map);
                    }
                },

                updateRiderMarker() {
                    // Hide if pending or no location
                    if (this.status === 'pending' || !this.map || !this.riderLat || !this.riderLng) {
                        if (this.riderMarker) {
                            this.map.removeLayer(this.riderMarker);
                            this.riderMarker = null;
                        }
                        return;
                    }

                    const riderIcon = L.divIcon({
                        className: 'smooth-marker',
                        html: `<div class="rider-marker-inner" style="background: linear-gradient(135deg, #22c55e, #10b981); width: 48px; height: 48px; border-radius: 50%; border: 4px solid white; box-shadow: 0 4px 20px rgba(34,197,94,0.5); display: flex; align-items: center; justify-content: center; font-size: 24px;">üõµ</div>`,
                        iconSize: [48, 48],
                        iconAnchor: [24, 24]
                    });

                    if (this.riderMarker) {
                        this.riderMarker.setLatLng([this.riderLat, this.riderLng]);
                        this.riderMarker.setIcon(riderIcon);
                        this.riderMarker.setZIndexOffset(1000);
                    } else {
                        this.riderMarker = L.marker([this.riderLat, this.riderLng], {
                            icon: riderIcon,
                            zIndexOffset: 1000
                        }).addTo(this.map);
                    }
                    this.updateRoute();
                },

                // Routing
                async updateRoute() {
                    if (!this.map) return;

                    // Define waypoints based on status
                    let waypoints = [];

                    // 1. Rider -> Pickup -> Dropoff (if pending/en_route)
                    if ((this.status === 'pending' || this.status === 'en_route_to_pickup') &&
                        this.riderLat && this.pickupLat && this.destLat) {
                        waypoints = [
                            { lat: this.riderLat, lng: this.riderLng },
                            { lat: this.pickupLat, lng: this.pickupLng },
                            { lat: this.destLat, lng: this.destLng }
                        ];
                    }
                    // 2. Rider -> Dropoff (if picked_up/active)
                    else if ((this.status === 'picked_up' || this.status === 'active') &&
                        this.riderLat && this.destLat) {
                        waypoints = [
                            { lat: this.riderLat, lng: this.riderLng },
                            { lat: this.destLat, lng: this.destLng }
                        ];
                    }
                    // 3. Just Pickup -> Dropoff (if no rider yet, or completed)
                    else if (this.pickupLat && this.destLat) {
                        waypoints = [
                            { lat: this.pickupLat, lng: this.pickupLng },
                            { lat: this.destLat, lng: this.destLng }
                        ];
                    }

                    if (waypoints.length < 2) return;

                    // Construct OSRM URL
                    const coords = waypoints.map(p => `${p.lng},${p.lat}`).join(';');
                    const url = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`;

                    try {
                        const response = await fetch(url);
                        const data = await response.json();

                        if (data.routes && data.routes[0]) {
                            const routeGeoJSON = data.routes[0].geometry;

                            if (this.routePolyline) {
                                this.map.removeLayer(this.routePolyline);
                            }

                            this.routePolyline = L.geoJSON(routeGeoJSON, {
                                style: {
                                    color: '#3b82f6',
                                    weight: 5,
                                    opacity: 0.7,
                                    lineJoin: 'round',
                                    dashArray: this.status === 'pending' ? '10, 10' : null
                                }
                            }).addTo(this.map);

                            // Optional: Update ETA and Distance from Route data
                            if (data.routes[0].duration) {
                                // OSRM returns duration in seconds
                                const minutes = Math.ceil(data.routes[0].duration / 60);
                                this.eta = `${minutes} min`;
                            }
                            if (data.routes[0].distance) {
                                const km = (data.routes[0].distance / 1000).toFixed(1);
                                this.distanceKm = km;
                            }
                        }
                    } catch (e) {
                        console.warn('Routing failed, fallback to straight line checks if needed', e);
                    }
                },


                fitMapBounds() {
                    if (!this.map) return;

                    const points = [];
                    if (this.pickupLat && this.pickupLng) points.push([this.pickupLat, this.pickupLng]);
                    if (this.riderLat && this.riderLng) points.push([this.riderLat, this.riderLng]);
                    if (this.destLat && this.destLng) points.push([this.destLat, this.destLng]);

                    if (points.length < 2) return;

                    const bounds = L.latLngBounds(points);
                    this.map.fitBounds(bounds, { padding: [80, 80], maxZoom: 16 });
                },

                calculateDistance(lat1, lng1, lat2, lng2) {
                    if (!lat1 || !lng1 || !lat2 || !lng2) return 0;
                    const R = 6371;
                    const dLat = (lat2 - lat1) * Math.PI / 180;
                    const dLng = (lng2 - lng1) * Math.PI / 180;
                    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLng / 2) * Math.sin(dLng / 2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                    return R * c;
                },

                updateCalculations() {
                    // Distance to customer's destination
                    const dist = this.calculateDistance(
                        this.riderLat, this.riderLng,
                        this.destLat, this.destLng
                    );
                    this.distanceKm = dist.toFixed(1);

                    // ETA based on Lagos traffic speed (~20 km/h average)
                    const etaMinutes = Math.round((dist * 1.4 / 20) * 60);
                    if (this.status === 'completed') {
                        this.eta = 'Done!';
                    } else if (etaMinutes < 1) {
                        this.eta = 'Arriving!';
                    } else if (etaMinutes < 60) {
                        this.eta = `${etaMinutes} min`;
                    } else {
                        const hours = Math.floor(etaMinutes / 60);
                        const mins = etaMinutes % 60;
                        this.eta = `${hours}h ${mins}m`;
                    }

                    // Proximity alert
                    if (etaMinutes <= 5 && !this.hasPlayedAlert && this.status !== 'pending') {
                        this.triggerProximityAlert();
                    }

                    // Progress bar (simple distance-based)
                    this.progress = Math.max(5, Math.min(100, (1 - dist / 15) * 100));
                    if (this.status === 'completed') this.progress = 100;

                    this.updateRoute();
                },

                triggerProximityAlert() {
                    this.hasPlayedAlert = true;
                    this.proximityAlertShown = true;

                    if ('vibrate' in navigator) {
                        navigator.vibrate([200, 100, 200, 100, 200]);
                    }

                    try {
                        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioCtx.createOscillator();
                        const gainNode = audioCtx.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioCtx.destination);

                        oscillator.frequency.value = 800;
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);

                        oscillator.start(audioCtx.currentTime);
                        oscillator.stop(audioCtx.currentTime + 0.5);

                        setTimeout(() => {
                            const osc2 = audioCtx.createOscillator();
                            const gain2 = audioCtx.createGain();
                            osc2.connect(gain2);
                            gain2.connect(audioCtx.destination);
                            osc2.frequency.value = 1000;
                            osc2.type = 'sine';
                            gain2.gain.setValueAtTime(0.3, audioCtx.currentTime);
                            gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                            osc2.start(audioCtx.currentTime);
                            osc2.stop(audioCtx.currentTime + 0.3);
                        }, 600);
                    } catch (e) {
                        console.log('Audio not available');
                    }
                },

                toggleSheet() {
                    this.sheetExpanded = !this.sheetExpanded;
                    // Re-invalidate map size when sheet changes
                    if (this.map) {
                        setTimeout(() => this.map.invalidateSize(), 400);
                    }
                },

                startMockUpdates() {
                    this.riderName = 'Solomon Dave';
                    this.riderPhone = '08012345678';
                    this.vehicleType = 'Yamaha MAX';
                    this.updateCalculations();

                    let mockStage = 0;
                    setInterval(() => {
                        const step = 0.002; // Faster for demo

                        // Phase 1: Move toward pickup
                        if (mockStage < 20) {
                            if (this.riderLat < this.pickupLat) this.riderLat += step;
                            if (this.riderLng < this.pickupLng) this.riderLng += step;
                            this.status = 'en_route_to_pickup';
                            mockStage++;
                        }
                        // Phase 2: At pickup, confirm pickup
                        else if (mockStage < 25) {
                            this.status = 'picked_up';
                            this.pickedUpAt = Date.now();
                            mockStage++;
                        }
                        // Phase 3: Move toward destination
                        else if (mockStage < 60) {
                            if (this.riderLat > this.destLat) this.riderLat -= step * 0.7;
                            if (this.riderLng < this.destLng) this.riderLng += step * 0.3;
                            this.status = 'active';
                            mockStage++;
                        }
                        // Phase 4: Complete
                        else {
                            this.status = 'completed';
                            this.riderLat = this.destLat;
                            this.riderLng = this.destLng;
                            this.eta = 'Done!';
                            this.progress = 100;

                            if (window.confetti && !this.confettiShown) {
                                confetti({
                                    particleCount: 150,
                                    spread: 70,
                                    origin: { y: 0.6 },
                                    colors: ['#22c55e', '#3b82f6', '#f59e0b']
                                });
                                this.confettiShown = true;
                            }
                        }

                        this.updateStatusLabel();
                        this.updateRiderMarker();
                        this.updateCalculations();
                        this.lastUpdate = 'Updated just now';
                    }, 500);
                }
            }));
        });
    </script>
</body>

</html>